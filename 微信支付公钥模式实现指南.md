# 微信支付公钥模式实现指南

## 概述

本文档详细说明了如何在微信支付库中实现公钥模式支持，以替代原有的证书模式。公钥模式是微信支付推荐的新方案，具有不会过期、无需定期更新的优势。

## 背景

微信支付API v3支持两种验签模式：
- **平台证书模式**（原有）：证书有效期为5年，需要定期更换
- **微信支付公钥模式**（新增）：公钥不会过期，管理更简单

新申请的商户号默认使用公钥模式，现有商户也可以从证书模式切换到公钥模式。

## 实现内容

本次更改包含以下功能：

1. 分账动账通知功能
2. 微信支付公钥模式支持

### 1. 分账动账通知

#### 1.1 配置更新

在 `WxPayConfigProperties` 中添加：
```kotlin
var profitSharingNotifyUrl: String? = null
```

#### 1.2 VO类创建

创建 `ProfitSharingNotifyVo.kt`，包含分账动账通知的数据结构：
```kotlin
data class ProfitSharingNotifyVo(
    val sp_mchid: String = "",
    val sub_mchid: String = "",
    val transaction_id: String = "",
    val order_id: String = "",
    val out_order_no: String = "",
    val receiver: ProfitSharingReceiver = ProfitSharingReceiver(),
    val success_time: String = ""
)
```

#### 1.3 回调处理

在 `WxPay` 类中添加回调处理方法：
```kotlin
fun profitSharingNotifyCallback(request: HttpServletRequest, apiV3Key: String): ProfitSharingNotifyVo?
```

### 2. 微信支付公钥模式

#### 2.1 配置类更新

在 `WxPayConfigProperties` 中添加：
```kotlin
var usePublicKeyMode: Boolean = false
var wechatPayPublicKey: String? = null
var wechatPayPublicKeyId: String? = null
```

#### 2.2 公钥配置类

创建 `WxPayPublicKeyConfig.kt`：
```kotlin
class WxPayPublicKeyConfig {
    private var publicKey: PublicKey? = null
    
    constructor(wechatPayPublicKey: String?, wechatPayPublicKeyId: String?)
    
    fun getPublicKey(): PublicKey?
    fun getPublicKeyId(): String?
    fun isValid(): Boolean
}
```

#### 2.3 WxPay类增强

修改 `WxPay` 类以支持公钥模式：

1. 添加公钥配置初始化：
```kotlin
private val usePublicKeyMode = wxConfigProperties.pay?.usePublicKeyMode ?: false
private val wechatPayPublicKeyConfig: WxPayPublicKeyConfig? = if (usePublicKeyMode) {
    WxPayPublicKeyConfig(
        wxConfigProperties.pay?.wechatPayPublicKey,
        wxConfigProperties.pay?.wechatPayPublicKeyId
    )
} else null
```

2. 更新序列号处理方法：
```kotlin
private fun resolveWechatpaySerialHeader(): String? {
    return if (usePublicKeyMode) {
        wechatPayPublicKeyConfig?.getPublicKeyId()
    } else {
        if (!publicKeyNo.isNullOrBlank()) ensurePubKeyIdPrefix(publicKeyNo!!) else payCert?.serial_no
    }
}
```

3. 修改验签方法：
```kotlin
fun verifyByPublicKey(str: String, signature: String, serial: String): Boolean {
    return if (usePublicKeyMode) {
        // 使用微信支付公钥验签
        if (serial != wechatPayPublicKeyConfig?.getPublicKeyId()) return false
        val rsa = Signature.getInstance(SIGN_METHOD)
        rsa.initVerify(wechatPayPublicKeyConfig?.getPublicKey())
        rsa.update(str.toByteArray(charset(UTF8)))
        rsa.verify(Base64.getDecoder().decode(signature))
    } else {
        // 使用平台证书验签
        // 原有逻辑
    }
}
```

4. 更新加密方法：
```kotlin
fun encodeSensitive(msg: String?): String? {
    val instance = Cipher.getInstance("RSA/ECB/OAEPWithSHA-1AndMGF1Padding")
    v3Key?.let {
        val key = if (usePublicKeyMode) {
            wechatPayPublicKeyConfig?.getPublicKey()
        } else {
            if (publicKeyNo.isNullOrBlank()) autoGenCert(v3Key)?.publicKey else genPublicKeyWithPath()
        }
        // 加密逻辑
    }
}
```

## 配置说明

### 证书模式配置

```yaml
wx:
  pay:
    use-public-key-mode: false
    mchid: "商户号"
    key-path: "path/to/apiclient_key.pem"
    serial-no: "证书序列号"
    v3key: "APIv3密钥"
    # 其他配置...
```

### 公钥模式配置

```yaml
wx:
  pay:
    use-public-key-mode: true
    mchid: "商户号"
    key-path: "path/to/apiclient_key.pem"  # 商户私钥仍然需要
    serial-no: "商户证书序列号"
    v3key: "APIv3密钥"
    wechat-pay-public-key: |
      -----BEGIN PUBLIC KEY-----
      MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
      -----END PUBLIC KEY-----
    wechat-pay-public-key-id: "PUB_KEY_ID_XXXXXXXXXXXXXXX"
    # 其他配置...
```

### 分账动账通知配置

```yaml
wx:
  pay:
    profit-sharing-notify-url: "https://your-domain.com/profit-sharing/notify"
    # 其他配置...
```

## 迁移步骤

### 从现有项目迁移

1. **复制文件**
   - 复制 `WxPayConfigProperties.kt` 中的新增属性
   - 复制 `WxPayPublicKeyConfig.kt` 文件
   - 复制 `ProfitSharingNotifyVo.kt` 文件

2. **修改WxPay类**
   - 添加公钥模式相关属性
   - 修改 `resolveWechatpaySerialHeader` 方法
   - 修改 `verifyByPublicKey` 方法
   - 修改 `encodeSensitive` 方法
   - 添加 `profitSharingNotifyCallback` 方法

3. **更新配置元数据**
   - 在 `spring-configuration-metadata.json` 中添加新配置项

4. **更新服务接口**
   - 在 `WxProfitSharingService` 中添加 `profitSharingNotifyCallback` 方法

### 获取微信支付公钥

1. 登录微信支付商户平台
2. 进入【账户中心】->【账户设置】->【API安全】
3. 在【微信支付公钥】部分下载公钥文件
4. 获取公钥ID

## 使用示例

### 分账动账通知处理

```kotlin
@PostMapping("/profit-sharing/notify")
fun handleProfitSharingNotify(request: HttpServletRequest): String {
    val result = wxPay.profitSharingNotifyCallback(request, apiV3Key)
    result?.let {
        // 处理分账动账业务逻辑
        logger.info("收到分账动账通知: 订单号=${it.out_order_no}, 金额=${it.receiver.amount}")
    }
    return "success"  // 返回success告知微信支付已正确处理
}
```

### 配置示例

#### application.yml（公钥模式）

```yaml
wx:
  app-id: "你的AppID"
  app-sec: "你的AppSecret"
  pay:
    use-public-key-mode: true
    mchid: "你的商户号"
    key-path: "/path/to/your/apiclient_key.pem"
    serial-no: "你的商户证书序列号"
    v3key: "你的APIv3密钥"
    wechat-pay-public-key: |
      -----BEGIN PUBLIC KEY-----
      # 这里填写从微信支付商户平台下载的公钥内容
      -----END PUBLIC KEY-----
    wechat-pay-public-key-id: "PUB_KEY_ID_XXXXXXXXXXXXXXX"
    notify-url: "https://your-domain.com/pay/notify"
    profit-sharing-notify-url: "https://your-domain.com/profit-sharing/notify"
```

## 注意事项

1. **兼容性**：现有证书模式代码保持不变，新功能不影响现有业务
2. **安全性**：公钥模式下仍需妥善保管商户私钥和APIv3密钥
3. **切换模式**：可以通过配置随时在证书模式和公钥模式之间切换
4. **分账动账**：分账动账通知需要配置独立的回调URL
5. **验签逻辑**：公钥模式和证书模式使用不同的验签逻辑

## 优势

1. **免维护**：公钥不会过期，无需定期更新
2. **简化管理**：减少了证书管理的复杂性
3. **官方推荐**：新申请商户号默认使用公钥模式
4. **平滑迁移**：支持从证书模式平滑切换到公钥模式

## 问题排查

1. **验签失败**
   - 检查公钥内容是否正确
   - 确认公钥ID是否匹配
   - 验证配置是否正确启用公钥模式

2. **加密失败**
   - 确认公钥格式正确
   - 检查敏感信息加密方法是否正确调用

3. **回调接收不到**
   - 确认回调URL配置正确
   - 检查网络是否可达
   - 验证返回值是否为"success"

## 相关文档

- [微信支付API v3概述](https://pay.weixin.qq.com/doc/v3/merchant/4012081606)
- [微信支付公钥使用指南](https://pay.weixin.qq.com/docs/merchant/products/platform-certificate/wxp-pub-key-guide.html)
- [平台证书切换微信支付公钥指引](https://pay.weixin.qq.com/docs/merchant/products/platform-certificate/update-pub-key.html)