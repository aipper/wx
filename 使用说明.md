# 使用说明

## 1. 项目概览
- `wx_lib` 基于 Kotlin + Spring Boot 3.3.2，面向对接微信公众号 / 小程序能力以及微信支付、支付宝支付。
- `com.ab.wx.wx_lib.wx` 提供公众号、网页授权、二维码、模板消息等 API 封装。
- `com.ab.wx.wx_lib.wx.WxPay` 保留了直连版微信支付/转账能力，便于需要直接调用 v3 API 的业务复用。
- `com.ab.wx.wx_lib.payment.*` 下提供统一的 `PaymentClient` 抽象，内部已经实现 `WechatPayClient` (`src/main/kotlin/com/ab/wx/wx_lib/payment/wechat/WechatPayClient.kt`) 和 `AlipayClient` (`src/main/kotlin/com/ab/wx/wx_lib/payment/alipay/AlipayClient.kt`)，支持下单/查询/关单/退款及回调验签。
- `docs/` 目录用于迁移计划、重构规划，可配合本文档快速了解库的能力后植入其它项目。

## 2. 运行要求与构建
- JDK 17（`pom.xml` 中的 `java.version`）
- Maven 3.9+（或兼容的构建工具）
- Spring Boot 3.3.x（自动装配文件 `META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports` 已声明 `PaymentAutoConfiguration`）

常用命令：
```bash
mvn clean package -DskipTests
```

## 3. 依赖引用
在目标项目的 `pom.xml` 中加入：
```xml
<dependency>
    <groupId>com.ab.wx</groupId>
    <artifactId>wx_lib</artifactId>
    <version>1.0.35</version>
</dependency>
```
发布到私服（`pom.xml` 的 `distributionManagement`）后直接引用即可。

## 4. 配置约定
### 4.1 微信公众号 / 小程序基配置（`WxConfigProperties`）
```yaml
wx:
  app-id: wx1234567890abcdef
  app-sec: your-app-secret
  mini-app-id: wx0987654321fedcba
  mini-app-sec: your-mini-secret
  mini-app-id-two: wxOptionalSecondMiniId
  mini-app-sec-two: optionalSecondMiniSecret
  wx-token: tokenUsedByServerCallback
  aes-key: optional-encoding-aes-key
  debug: true
  pay:
    mchid: 1900000109
    notify-url: https://example.com/pay/wechat/notify
    refunds-notify-url: https://example.com/pay/wechat/refund
    v3key: 32byteslongapikeyxxxxxxxxxxxxxxx
    key-path: classpath:certs/apiclient_key.pem
    serial-no: 1234567890ABCDE1234567890ABCDE1234567890
    trans-callback-url: https://example.com/pay/wechat/transfer
```
> `wx.pay.*` 的字段由 `WxPay` 使用，和统一支付客户端的 `wx.payment.*` 配置互不影响。

### 4.2 微信支付统一客户端（`WxPaymentProperties`）
支持直连 & 服务商两种模式，可维护多商户：
```yaml
wx:
  payment:
    default-merchant: main
    merchants:
      main:
        description: 直营商户
        mode: DIRECT                    # 直连：无需 sub-merchant
        app-id: wx1234567890abcdef
        mchid: 1900000109
        serial-no: 444F4863E3...
        api-v3-key: 32byteslongapikeyxxxxxxxxxxxxxxx
        private-key: |-
          -----BEGIN PRIVATE KEY-----
          ...
          -----END PRIVATE KEY-----
        key-path: classpath:certs/apiclient_key.pem
        notify-url: https://example.com/pay/wechat/notify
        refunds-notify-url: https://example.com/pay/wechat/refund
        domain: https://api.mch.weixin.qq.com
        cert-refresh-minutes: 10
      service-provider:
        description: 服务商商户
        mode: SERVICE_PROVIDER
        app-id: wxspAppId
        mchid: 1900009999
        serial-no: 123ABC456DEF
        api-v3-key: 32byteslongapikeyxxxxxxxxxxxxxxx
        key-path: classpath:certs/service_provider_key.pem
        sub-merchants:
          shop-a:
            mchid: 1900010001
            app-id: wxshopASubAppId
            notify-url: https://example.com/pay/wechat/shop-a/notify
            refunds-notify-url: https://example.com/pay/wechat/shop-a/refund
```
- `default-merchant`：`CreateOrderCommand.merchantId` 为空时的默认值。
- 服务商模式必须传 `subMerchantId`，客户端会在 `WxMerchantProperties.subMerchants` 下匹配配置。

### 4.3 支付宝支付统一客户端（`AlipayProperties`）
```yaml
alipay:
  payment:
    default-merchant: default
    merchants:
      default:
        app-id: 2021000118630080
        private-key-path: classpath:certs/alipay_app_private_key.pem
        alipay-public-key-path: classpath:certs/alipay_platform_public_key.pem
        endpoint: https://openapi.alipay.com/gateway.do
        notify-url: https://example.com/pay/alipay/notify
        return-url: https://example.com/pay/alipay/return
        charset: utf-8
        sign-type: RSA2
```
也可以改为直接在配置中粘贴 `private-key` / `alipay-public-key`，客户端会自动缓存解析后的密钥。

## 5. 统一支付客户端（`PaymentClient`）
接口定义位于 `payment/api/PaymentClient.kt`，核心模型见 `PaymentModels.kt`：
- `CreateOrderCommand`：金额单位为分，`payer.openId`（微信）/`payer.userId`（支付宝小程序）等字段根据渠道选择。
- `PaymentChannel`：微信 JSAPI/H5/NATIVE/APP/小程序，支付宝 APP/WAP/PAGE/小程序。
- 统一返回 `CreateOrderResult` / `QueryOrderResult` / `CloseOrderResult` / `RefundResult`。

在 Spring Boot 应用中直接注入：
```kotlin
@Service
class PayService(
    @Qualifier("wechatPaymentClient") private val wechatClient: PaymentClient,
    @Qualifier("alipayPaymentClient") private val alipayClient: PaymentClient,
) {
    fun createWechatJsapi(orderNo: String, openId: String): Map<String, Any?> {
        val command = CreateOrderCommand(
            merchantId = "main",
            channel = PaymentChannel.WECHAT_JSAPI,
            outTradeNo = orderNo,
            description = "订单$orderNo",
            amount = Money(total = 100),
            payer = Payer(openId = openId),
            notifyUrl = "https://example.com/pay/wechat/notify"
        )
        return wechatClient.createOrder(command).credential
    }
}
```

### 5.1 微信支付能力
`WechatPayClient` 支持：
- 渠道：`WECHAT_JSAPI`、`WECHAT_MINI_APP`、`WECHAT_H5`、`WECHAT_NATIVE`、`WECHAT_APP`。
- 统一生成前端调起参数（JSAPI/小程序）、H5 跳转链接、Native 支付码链接、App 签名参数。
- 订单查询/关单/退款，自动解析 `trade_state`、`refund_status` 为 `PaymentStatus`。
- 多商户多证书缓存、平台证书自动刷新 (`certRefreshMinutes`)。

示例：
```kotlin
val result = wechatClient.createOrder(
    command.copy(channel = PaymentChannel.WECHAT_NATIVE)
)
val qrUrl = result.credential["codeUrl"]
```
`WechatPayClient` 还暴露：
```kotlin
fun parsePaymentNotification(merchantId: String?, subMerchantId: String?, headers: HttpHeaders, body: String): H5PayDecodeVo?
fun parseRefundNotification(...): H5RefundsDecodeVo?
```
便于回调验签与解密，加密解密由 `WxPayAes` 完成。

### 5.2 支付宝支付能力
`AlipayClient` 支持渠道：`ALIPAY_APP`、`ALIPAY_WAP`、`ALIPAY_PAGE`、`ALIPAY_MINI_PROGRAM`。
- APP/WAP/PAGE：`credential` 返回完整的 `orderStr`，直接交给客户端 SDK 或前端发起跳转。
- 小程序：返回 `tradeNo`，由前端调用 `my.tradePay`。
- `queryOrder` / `closeOrder` / `refund` 统一调用 OpenAPI，自动抛出 `PaymentClientException`。
- `parsePaymentNotification(merchantId, params)` 提供回调验签。

示例：
```kotlin
val wapResult = alipayClient.createOrder(
    CreateOrderCommand(
        merchantId = "default",
        channel = PaymentChannel.ALIPAY_WAP,
        outTradeNo = orderNo,
        description = "订单$orderNo",
        amount = Money(total = 100),
        notifyUrl = "https://example.com/pay/alipay/notify"
    )
)
val orderStr = wapResult.credential["orderStr"]
```

## 6. 支付回调处理
### 6.1 微信支付
```kotlin
@RestController
class WechatNotifyController(private val client: WechatPayClient) {
    @PostMapping("/pay/wechat/notify")
    fun notify(@RequestBody body: String, request: HttpServletRequest): ResponseEntity<String> {
        val headers = HttpHeaders()
        request.headerNames.iterator().forEach { headers.add(it, request.getHeader(it)) }
        val payload = client.parsePaymentNotification("main", null, headers, body)
        return if (payload != null && payload.trade_state == "SUCCESS") {
            // TODO 更新订单状态
            ResponseEntity.ok("{\"code\":\"SUCCESS\"}")
        } else {
            ResponseEntity.status(500).body("{\"code\":\"FAIL\"}")
        }
    }
}
```
- `parseNotification` 会先验签 (`Wechatpay-*` 头) 再用 `apiV3Key` 解密。
- 退款回调同理调用 `parseRefundNotification`。

### 6.2 支付宝支付
```kotlin
@PostMapping("/pay/alipay/notify")
fun notify(@RequestParam params: Map<String, String>): String {
    val notify = alipayClient.parsePaymentNotification("default", params)
        ?: return "failure"
    if (notify.status == PaymentStatus.SUCCESS) {
        // TODO 更新订单
    }
    return "success"
}
```
回调参数须原样传入以确保验签成功。

## 7. 微信公众号 / 小程序辅助能力
### 7.1 `Wx`
主要方法位于 `wx/Wx.kt`：
- `genToken()` / `setToken()` / `getTicket()`：拉取并缓存 `access_token`、`jsapi_ticket`。
- `createMenu`、`sendTemplate`：菜单 & 模板消息。
- `genPermanentQrCode` / `genExpiredQrCode` / `showQrCode`：二维码生成。
- `getUserInfo`、`getH5UserAccessToken`、`getH5User`：网页授权用户信息。
- `check(...)`：公众号服务器接入签名校验。

典型注入：
```kotlin
@Configuration
@EnableConfigurationProperties(WxConfigProperties::class)
class WxBeans(private val props: WxConfigProperties) {
    @Bean fun wx(): Wx = Wx(props)
    @Bean fun wxPay(): WxPay = WxPay(props)
    @Bean fun miniApp(): MiniApp = MiniApp(props.miniAppId, props.miniAppSec)
}
```
> 提醒：`WxConst` 存储的 token/ticket 是进程级静态变量，部署多实例时需要外部共享。

### 7.2 `MiniApp`
`wx/MiniApp.kt` 封装了：
- `getCode2Session(code)`：`jscode2session`。
- `genAccessToken()` / `setAccessToken()`：生成并缓存小程序 `access_token`。
- `uniformMsgSend`：保留统一服务消息调用入口（可继续扩展）。

### 7.3 `WxPay`
- `genSimplePay`、`genMiniAppPay`：直接调用微信 v3 JSAPI/小程序接口，返回前端签名。
- `transfer`：企业付款到零钱，内部自动调用 `WxPayAes` 对敏感字段做加密。
- `verity`：验签；`WxPayAes.decryptToString`、`genToken` 提供了平台证书获取、回调解密工具。

## 8. 常见问题 / 排查建议
1. **`notify_url must be provided`**：`WechatPayClient` 在 `determineNotifyUrl` 中会校验三层级（命令参数 -> 子商户 -> 商户），缺失会抛异常。
2. **`subMerchantId is required`**：服务商模式必须带上 `subMerchantId`，否则 `resolveMerchant` 会阻断。
3. **`api-v3-key` 长度**：必须 32 字节；否则 AES/GCM 解密会失败。
4. **支付宝验签失败**：确认 `charset` 与 `sign_type` 一致，且回调参数未经 URLDecode。
5. **公众号 token/ticket**：调用 `Wx.genToken()` 后才会填充 `WxConst.accessToken`，一般可在启动时主动刷新。

## 9. 微信/支付宝对接状态
- 微信支付：`WechatPayClient` 已覆盖 JSAPI/小程序/H5/Native/App 下单、查单、关单、退款，以及证书管理、回调验签解密，能够满足目前业务对接。
- 支付宝支付：`AlipayClient` 已覆盖 APP/WAP/PAGE/小程序下单、查单、关单、退款，同时内建签名、验签、回调解析。若需更多 API，可在 `payment/alipay/AlipayClient.kt` 中复用 `callApi` 与签名工具扩展。

按上述说明准备配置、依赖和示例代码后，即可在其他项目中快速注入相关 Bean 并完成微信/支付宝的支付及消息能力对接。
